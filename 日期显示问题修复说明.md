# 日期显示问题修复说明

## 问题描述

在访问 `http://localhost:5173/okr` 时，出现以下问题：
1. 页面表格中的开始日期、结束日期显示为 "Invalid Date"
2. 点击"编辑"按钮时，模态框中的日期选择器无法显示日期

## 问题原因

### 1. 表格日期显示问题
**原因**：Ant Design Vue 4.x 的 `customRender` 函数参数结构发生了变化。

**旧版本（错误）：**
```javascript
customRender: (text) => new Date(text).toLocaleDateString()
```

**新版本（正确）：**
```javascript
customRender: ({ text }) => {
  if (text && !isNaN(new Date(text).getTime())) {
    return new Date(text).toLocaleDateString();
  }
  return '';
}
```

在 Ant Design Vue 4.x 中，`customRender` 接收一个对象参数，包含 `text`、`record`、`index` 等属性，而不是直接接收值。

### 2. 日期选择器编辑问题
**原因**：Ant Design Vue 4.x 使用 `dayjs` 作为日期处理库，而不是原生 JavaScript `Date` 对象。

**错误做法：**
```javascript
startDate: new Date(record.startDate)
```

**正确做法：**
```javascript
import dayjs from 'dayjs/esm';

startDate: dayjs(record.startDate)
```

### 3. v-model 绑定问题
**原因**：日期选择器的 v-model 绑定方式在 Vue 3 中需要使用 `v-model:value`。

**错误做法：**
```vue
<a-date-picker v-model="objectiveForm.startDate" />
```

**正确做法：**
```vue
<a-date-picker v-model:value="objectiveForm.startDate" format="YYYY-MM-DD" />
```

## 修复内容

### 1. 修改 `frontend/src/views/OKRManagement.vue`

#### 1.1 导入 dayjs
```javascript
import dayjs from 'dayjs/esm';
```

#### 1.2 修复表格日期列的 customRender
```javascript
{
  title: '开始日期',
  dataIndex: 'startDate',
  key: 'startDate',
  customRender: ({ text }) => {
    if (text && !isNaN(new Date(text).getTime())) {
      return new Date(text).toLocaleDateString();
    }
    return '';
  }
},
{
  title: '结束日期',
  dataIndex: 'endDate',
  key: 'endDate',
  customRender: ({ text }) => {
    if (text && !isNaN(new Date(text).getTime())) {
      return new Date(text).toLocaleDateString();
    }
    return '';
  }
}
```

#### 1.3 修复编辑时的日期转换
```javascript
const handleEditObjective = (record) => {
  const { departmentId, ...recordWithoutDepartment } = record;
  objectiveForm.value = {
    ...recordWithoutDepartment,
    startDate: (record.startDate && !isNaN(new Date(record.startDate).getTime())) 
      ? dayjs(record.startDate) 
      : null,
    endDate: (record.endDate && !isNaN(new Date(record.endDate).getTime())) 
      ? dayjs(record.endDate) 
      : null
  };
  showObjectiveModal.value = true;
};
```

#### 1.4 修复保存时的日期转换
```javascript
const handleSaveObjective = async () => {
  try {
    const objectiveData = {
      ...objectiveForm.value,
      startDate: objectiveForm.value.startDate 
        ? dayjs(objectiveForm.value.startDate).toISOString() 
        : null,
      endDate: objectiveForm.value.endDate 
        ? dayjs(objectiveForm.value.endDate).toISOString() 
        : null
    };
    // ... 其余代码
  }
};
```

#### 1.5 修复日期选择器的 v-model 绑定
```vue
<a-form-item name="startDate" label="开始日期">
  <a-date-picker v-model:value="objectiveForm.startDate" style="width: 100%" format="YYYY-MM-DD" />
</a-form-item>
<a-form-item name="endDate" label="结束日期">
  <a-date-picker v-model:value="objectiveForm.endDate" style="width: 100%" format="YYYY-MM-DD" />
</a-form-item>
```

### 2. 修改 `frontend/src/views/Home.vue`

#### 2.1 修复表格日期列的 customRender
```javascript
{
  title: '结束日期',
  dataIndex: 'endDate',
  key: 'endDate',
  customRender: ({ text }) => {
    if (text && !isNaN(new Date(text).getTime())) {
      return new Date(text).toLocaleDateString();
    }
    return '';
  }
}
```

## 技术要点

### 1. Ant Design Vue 4.x 的 customRender
在 Ant Design Vue 4.x 中，`customRender` 函数接收一个对象参数：
```javascript
customRender: ({ text, record, index, column }) => {
  // text: 当前单元格的值
  // record: 当前行的数据对象
  // index: 当前行的索引
  // column: 当前列的配置
}
```

### 2. dayjs 的使用
Ant Design Vue 4.x 内置了 dayjs，可以直接导入使用：
```javascript
import dayjs from 'dayjs/esm';

// 创建 dayjs 对象
const date = dayjs('2024-01-01');

// 格式化
date.format('YYYY-MM-DD');

// 转换为 ISO 字符串
date.toISOString();

// 转换为 Date 对象
date.toDate();
```

### 3. 日期验证
在处理日期时，始终进行有效性验证：
```javascript
if (text && !isNaN(new Date(text).getTime())) {
  // 日期有效
  return new Date(text).toLocaleDateString();
}
return ''; // 日期无效，返回空字符串
```

### 4. Vue 3 的 v-model
在 Vue 3 中，组件的 v-model 需要明确指定属性名：
```vue
<!-- Vue 2 -->
<a-date-picker v-model="date" />

<!-- Vue 3 -->
<a-date-picker v-model:value="date" />
```

## 测试验证

### 1. 测试表格日期显示
1. 访问 `http://localhost:5173/okr`
2. 检查表格中的"开始日期"和"结束日期"列
3. 确认显示格式正确（如：2024/1/21）
4. 确认没有 "Invalid Date" 显示

### 2. 测试日期编辑
1. 点击任意目标的"编辑"按钮
2. 检查模态框中的日期选择器
3. 确认日期正确显示在选择器中
4. 尝试修改日期并保存
5. 确认修改后的日期正确保存和显示

### 3. 测试新建目标
1. 点击"新建目标"按钮
2. 选择开始日期和结束日期
3. 填写其他必填字段
4. 保存目标
5. 确认新建的目标日期显示正确

## 常见问题

### Q1: 为什么要使用 dayjs 而不是 Date？
**A**: Ant Design Vue 4.x 的日期组件内部使用 dayjs，直接使用 Date 对象会导致类型不匹配。dayjs 提供了更好的 API 和更小的体积。

### Q2: 如果日期仍然显示 Invalid Date 怎么办？
**A**: 检查以下几点：
1. 确认后端返回的日期格式是否正确（应为 ISO 8601 格式）
2. 检查浏览器控制台是否有错误信息
3. 确认 dayjs 是否正确导入
4. 检查日期验证逻辑是否正确

### Q3: 日期格式如何自定义？
**A**: 可以通过 `format` 属性自定义：
```vue
<a-date-picker 
  v-model:value="date" 
  format="YYYY年MM月DD日" 
/>
```

### Q4: 如何处理时区问题？
**A**: dayjs 默认使用本地时区，如需处理 UTC 时间：
```javascript
import dayjs from 'dayjs/esm';
import utc from 'dayjs/plugin/utc';

dayjs.extend(utc);

const utcDate = dayjs.utc('2024-01-01');
```

## 相关文档

- [Ant Design Vue 4.x 文档](https://antdv.com/components/overview-cn)
- [dayjs 文档](https://day.js.org/docs/zh-CN/installation/installation)
- [Vue 3 文档](https://cn.vuejs.org/)

## 总结

本次修复主要解决了以下问题：
1. ✅ 修复表格中日期显示为 "Invalid Date" 的问题
2. ✅ 修复编辑时日期选择器无法显示日期的问题
3. ✅ 统一使用 dayjs 处理日期
4. ✅ 正确使用 Ant Design Vue 4.x 的 API

修复后，日期功能应该完全正常工作，包括：
- 表格中正确显示日期
- 编辑时正确加载日期
- 新建时正确选择日期
- 保存时正确提交日期

如有其他问题，请检查浏览器控制台的错误信息，或参考本文档的常见问题部分。
